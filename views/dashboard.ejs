<!DOCTYPE html>
<html lang="en">
<%- include('layouts/header.ejs') %>

<body>
  <h1><%= title %></h1>
  <!-- untuk add product -->
  <button onclick="toggleAddForm()">Add Product</button>
  <div id="addForm" style="display: none;">
    <h2>Add Product</h2>
    <form action="/admin/dashboard/add" method="post" onsubmit="return cleanUpId('productID', 'post')" enctype="multipart/form-data">
      <input type="hidden" name="currentPage" value="<%= currentPage %>">
      <label for="productID">ID:</label>
      <input type="text" id="productID" name="id" required><br>
      <label for="productName">Name:</label>
      <input type="text" id="productName" name="name" required><br>
      <label for="productPrice">Price:</label>
      <input type="number" id="productPrice" name="price" required><br>
      <label for="productDescription">Description:</label>
      <textarea id="productDescription" name="description" required></textarea><br>
      <label for="productBigImage">Big Image:</label>
      <input type="file" id="productBigImage" name="bigImage" required accept="image/*"><br>
      <label for="productSmallImages">Small Images:</label>
      <input type="file" id="productSmallImages" name="smallImages" multiple required accept="image/*"><br>
      <button type="submit">Add</button>
    </form>
  </div>
  <% if (products.length === 0) { %>
  <p>No products found.</p>
  <% } else { %>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Price</th>
        <th>Description</th>
        <th>Big Image</th>
        <th>Small Images</th>
        <th>Action</th>
        <th>Link</th>
      </tr>
    </thead>
    <tbody>
      <% products.forEach(product => { %>
      <tr>
        <td><%= product.id %></td>
        <td><%= product.name %></td>
        <td>IDR<%= product.price %></td>
        <td><%= product.description %></td>
        <td><%= product.bigImage %></td>
        <td>
          <% product.smallImages.forEach(image => { %>
          <%= image %><br>
          <% }); %>
        </td>

        <!-- tombol action untuk edit dan delete -->
        <td>
          <button onclick="toggleEditForm('<%= product.id %>')">Edit</button>
          <button onclick="deleteProduct('<%= product._id %>')">Delete</button>
        </td>

        <td><a href="/detail/<%= product.id %>" target="_blank"><%= product.name %></a></td>
      </tr>

      <!-- form edit dengan toggle -->
      <tr id="editForm<%= product.id %>" style="display: none;">
        <td colspan="6">
          <form id="editForm<%= product.id %>" action="/admin/dashboard/edit/<%= product._id %>?_method=put" method="post" onsubmit="return cleanUpId('editID', 'put')">
            <input type="hidden" name="currentPage" value="<%= currentPage %>">
            <label for="editID">ID:</label>
            <input type="text" id="editID" name="id" value="<%= product.id %>" required><br>
            <label for="editName">Name:</label>
            <input type="text" id="editName" name="name" value="<%= product.name %>" required><br>
            <label for="editPrice">Price:</label>
            <input type="number" id="editPrice" name="price" value="<%= product.price %>" required><br>
            <label for="editDescription">Description:</label>
            <textarea id="editDescription" name="description" required><%= product.description %></textarea><br>
            <label for="editBigImage">Big Image:</label>
            <input type="text" id="editBigImage" name="bigImage" value="<%= product.bigImage %>" required><br>
            <label for="editSmallImages">Small Images:</label>
            <textarea id="editSmallImages" name="smallImages" required><%= product.smallImages.join('\n') %></textarea><br>
            <button type="submit">Save</button>
          </form>
        </td>
      </tr>

      <% }); %>
    </tbody>
  </table>
  <% } %>

  <!-- pagination -->
  <div class="pagination">
    <% for(let i = 1; i <= totalPages; i++) { %>
    <a href="/admin/dashboard?page=<%= i %>" class="<%= currentPage === i ? 'active' : '' %>"><%= i %></a>
    <% } %>
  </div>

  <script>
    let openFormId = null;

    // toggle edit form dan hanya 1 edit form yang terbuka
    function toggleEditForm(productId) {
      const editForm = document.getElementById(`editForm${productId}`);
      if (openFormId && openFormId !== productId) {
        const previousForm = document.getElementById(`editForm${openFormId}`);
        if (previousForm) {
          previousForm.style.display = "none";
        }
      }
      if (editForm.style.display === "none") {
        editForm.style.display = "table-row";
        openFormId = productId;
      } else {
        editForm.style.display = "none";
        openFormId = null;
      }
    }

    // toggle untuk add form
    function toggleAddForm() {
      const addForm = document.getElementById("addForm");
      if (addForm.style.display === "none") {
        addForm.style.display = "block";
      } else {
        addForm.style.display = "none";
      }
    }

    // clean id produk dari karakter khusus dan spasi kecuali - dan _
    function cleanUpId(id, method) {
      const productIdInput = document.getElementById(id);
      productIdInput.value = productIdInput.value
        .toLowerCase()
        .replace(/\s/g, "")
        .replace(/[^a-zA-Z0-9-_]/g, "");
      if (method === "post") {
        return confirm("Are you sure you want to add this product?");
      } else if (method === "put") {
        return confirm("Are you sure you want to save changes?");
      }
    }

    // delete produk sesuai _id
    function deleteProduct(productId) {
      if (confirm("Are you sure you want to delete this product?")) {
        fetch(`/admin/dashboard/delete/${productId}`, {
            method: "DELETE",
          })
          .then((response) => {
            if (response.ok) {
              window.location.reload();
            } else {
              throw new Error("Failed to delete product");
            }
          })
          .catch((error) => {
            alert("Failed to delete product. Please try again.");
          });
      }
    }
  </script>


</body>

</html>